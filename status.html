<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acore 构建状态监控</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        success: '#2ecc71',
                        pending: '#f39c12',
                        failure: '#e74c3c',
                        cancelled: '#95a5a6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'spin-slow': 'spin 2s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .status-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .card-hover {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .lang-btn {
                transition: all 0.2s ease;
            }
            .lang-btn.active {
                background-color: #2c3e50;
                color: white;
            }
            .icon-dynamic {
                transition: all 0.3s ease;
            }
            .updating {
                transition: all 0.3s ease;
            }
            .history-item {
                transition: all 0.3s ease;
            }
            .status-legend {
                transition: all 0.3s ease;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* 状态说明面板过渡效果 */
        #status-legend-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        #status-legend-content:not(.hidden) {
            max-height: 300px;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 状态说明面板 -->
        <div class="mb-6 status-legend">
            <button id="toggle-legend" class="flex items-center text-primary hover:text-primary/80 font-medium">
                <i class="fa fa-info-circle mr-2"></i>
                <span data-i18n="statusLegend">状态说明</span>
                <i id="legend-icon" class="fa fa-chevron-down ml-2 text-xs transition-transform duration-300"></i>
            </button>
            <div id="status-legend-content" class="hidden mt-3 bg-white p-4 rounded-lg shadow-md text-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div class="flex items-center">
                        <i class="fa fa-clock-o text-pending animate-pulse-slow mr-2"></i>
                        <span data-i18n="status.queued">排队中</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa fa-refresh text-pending animate-spin-slow mr-2"></i>
                        <span data-i18n="status.in_progress">构建中</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa fa-check-circle text-success animate-bounce-slow mr-2"></i>
                        <span data-i18n="status.completed.success">成功</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa fa-times-circle text-failure animate-bounce-slow mr-2"></i>
                        <span data-i18n="status.completed.failure">失败</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa fa-ban text-cancelled animate-pulse-slow mr-2"></i>
                        <span data-i18n="status.completed.cancelled">已取消</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa fa-exclamation-triangle text-failure animate-bounce-slow mr-2"></i>
                        <span data-i18n="status.error">获取数据失败</span>
                    </div>
                </div>
            </div>
        </div>

        <header class="mb-10 text-center">
            <div class="flex justify-end mb-4">
                <div class="flex space-x-2">
                    <button id="lang-zh" class="lang-btn active px-3 py-1 rounded text-sm border border-primary/30">中文</button>
                    <button id="lang-en" class="lang-btn px-3 py-1 rounded text-sm border border-primary/30">English</button>
                </div>
            </div>
            
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2" data-i18n="title">
                <i class="fa fa-github mr-3"></i>Acore 构建状态监控
            </h1>
            <p class="text-gray-600" data-i18n="subtitle">实时跟踪工作流构建结果</p>
            <div class="mt-4 flex justify-center items-center space-x-2 text-sm text-gray-500">
                <span id="last-update" data-i18n="lastUpdate">最后更新：从未</span>
                <span class="inline-block w-2 h-2 rounded-full bg-gray-400"></span>
                <span id="status-indicator" data-i18n="waiting">等待开始...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="workflow-container">
            <!-- 工作流状态卡片将通过JS动态生成 -->
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-8">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold flex items-center" data-i18n="historyTitle">
                    <i class="fa fa-history text-primary mr-2"></i>构建历史记录
                </h2>
                <div class="flex items-center text-sm">
                    <span data-i18n="historyRecordsPerWorkflow">每条工作流显示：</span>
                    <select id="history-count-select" class="ml-2 border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="2">2条</option>
                        <option value="3" selected>3条</option>
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                    </select>
                </div>
            </div>
            <div id="history-container" class="space-y-2 max-h-[600px] overflow-y-auto p-2">
                <!-- 历史记录将按工作流分组显示 -->
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm py-4" data-i18n="footer">
            <p>数据来源: GitHub API | 刷新间隔: 60秒</p>
        </footer>
    </div>

    <script>
        // 语言翻译映射
        const translations = {
            zh: {
                title: "Acore 构建状态监控",
                subtitle: "实时跟踪工作流构建结果",
                lastUpdate: "最后更新：从未",
                waiting: "等待开始...",
                initializing: "正在初始化工作流...",
                initFailed: "初始化失败",
                partialInitFailed: "部分工作流初始化失败",
                initCompleted: "工作流初始化完成",
                updating: "正在更新状态...",
                updateCompleted: "更新完成",
                updateFailed: "更新失败",
                viewDetails: "查看详情",
                historyTitle: "构建历史记录",
                historyRecordsPerWorkflow: "每条工作流显示：",
                noHistory: "暂无任何构建记录",
                noHistoryForWorkflow: "暂无该工作流的构建记录",
                footer: "数据来源: GitHub API | 刷新间隔: 60秒",
                statusLegend: "状态说明",
                status: {
                    queued: "排队中",
                    in_progress: "构建中",
                    completed: {
                        success: "成功",
                        failure: "失败",
                        cancelled: "已取消",
                        neutral: "中性",
                        default: "未知"
                    },
                    no_runs: "无运行记录",
                    error: "获取数据失败",
                    unknown: "未知状态"
                },
                time: {
                    justNow: "刚刚",
                    minutesAgo: "{0}分钟前",
                    hoursAgo: "{0}小时前",
                    daysAgo: "{0}天前"
                }
            },
            en: {
                title: "Acore Build Status Monitor",
                subtitle: "Real-time tracking of key workflow results",
                lastUpdate: "Last update: Never",
                waiting: "Waiting to start...",
                initializing: "Initializing workflows...",
                initFailed: "Initialization failed",
                partialInitFailed: "Partial workflow initialization failed",
                initCompleted: "Workflow initialization completed",
                updating: "Updating status...",
                updateCompleted: "Update completed",
                updateFailed: "Update failed",
                viewDetails: "View details",
                historyTitle: "Build History",
                historyRecordsPerWorkflow: "Records per workflow:",
                noHistory: "No build records available",
                noHistoryForWorkflow: "No build records for this workflow",
                footer: "Data source: GitHub API | Refresh interval: 60s",
                statusLegend: "Status Legend",
                status: {
                    queued: "Queued",
                    in_progress: "In progress",
                    completed: {
                        success: "Success",
                        failure: "Failure",
                        cancelled: "Cancelled",
                        neutral: "Neutral",
                        default: "Unknown"
                    },
                    no_runs: "No run records",
                    error: "Failed to fetch data",
                    unknown: "Unknown status"
                },
                time: {
                    justNow: "Just now",
                    minutesAgo: "{0} minutes ago",
                    hoursAgo: "{0} hours ago",
                    daysAgo: "{0} days ago"
                }
            }
        };

        // 当前语言
        let currentLang = 'zh';

        // 配置信息
        const config = {
            token: "{{API_GITHUB_TOKEN}}",
            interval: 60000, // 1分钟刷新一次
            historyRecordsPerWorkflow: 3, // 每个工作流默认显示的历史记录数量
            workflows: [
                { 
                    id: "Win_X64", 
                    name: { zh: 'Win_X64', en: 'Win_X64' }, 
                    file: 'Win_X64.yml', 
                    owner: 'game760', 
                    repo: 'Acore' 
                },
                { 
                    id: "Linux_x64", 
                    name: { zh: 'Linux_X64', en: 'Linux_X64' }, 
                    file: 'Linux_x64.yml', 
                    owner: 'game760', 
                    repo: 'Acore' 
                },
                { 
                    id: "Database", 
                    name: { zh: 'Database', en: 'Database' }, 
                    file: 'Database.yml', 
                    owner: 'game760', 
                    repo: 'Acore' 
                }, 
                { 
                    id: "Map", 
                    name: { zh: 'Map', en: 'Map' }, 
                    file: 'MapData.yml', 
                    owner: 'game760', 
                    repo: 'mapdata' 
                }
            ]
        };

        // 存储工作流ID映射
        const workflowIds = {};
        // 按工作流分组存储历史记录（键：工作流唯一标识，值：该工作流的记录数组）
        const groupedHistory = {};

        // 动态状态图标映射（带动画效果）
        const statusIcons = {
            queued: { icon: 'fa-clock-o', color: 'pending', animation: 'animate-pulse-slow' },
            in_progress: { icon: 'fa-refresh', color: 'pending', animation: 'animate-spin-slow' },
            completed: {
                success: { icon: 'fa-check-circle', color: 'success', animation: 'animate-bounce-slow' },
                failure: { icon: 'fa-times-circle', color: 'failure', animation: 'animate-bounce-slow' },
                cancelled: { icon: 'fa-ban', color: 'cancelled', animation: 'animate-pulse-slow' },
                neutral: { icon: 'fa-minus-circle', color: 'gray-500', animation: '' },
                default: { icon: 'fa-question-circle', color: 'gray-400', animation: '' }
            },
            no_runs: { icon: 'fa-file-text-o', color: 'gray-400', animation: '' },
            error: { icon: 'fa-exclamation-triangle', color: 'failure', animation: 'animate-bounce-slow' },
            unknown: { icon: 'fa-question-circle', color: 'gray-400', animation: '' }
        };

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定语言切换事件
            document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            
            // 绑定状态说明面板切换事件
            document.getElementById('toggle-legend').addEventListener('click', toggleStatusLegend);
            
            // 绑定历史记录数量选择事件
            document.getElementById('history-count-select').addEventListener('change', function() {
                config.historyRecordsPerWorkflow = parseInt(this.value);
                // 重新渲染历史记录
                renderHistory();
            });
            
            createWorkflowCards();
            
            if (!config.token) {
                // 无Token时显示友好提示
                const container = document.getElementById('workflow-container');
                container.innerHTML = `
                    <div class="col-span-full bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-800">
                        <h3 class="font-semibold flex items-center">
                            <i class="fa fa-exclamation-circle mr-2"></i>请配置GitHub Token
                        </h3>
                        <p class="mt-2 text-sm">
                            1. 前往GitHub -> 设置 -> 开发者设置 -> 个人访问令牌（PAT）<br>
                            2. 生成令牌时勾选 "repo" 和 "workflow" 权限<br>
                            3. 将令牌填入代码中 config.token 的位置（替换 "{{API_GITHUB_TOKEN}}"）
                        </p>
                    </div>
                `;
            } else {
                fetchAllWorkflowIds();
                setInterval(fetchAllWorkflowStatuses, config.interval);
            }
        });

        // 切换状态说明面板显示/隐藏
        function toggleStatusLegend() {
            const content = document.getElementById('status-legend-content');
            const icon = document.getElementById('legend-icon');
            
            content.classList.toggle('hidden');
            if (!content.classList.contains('hidden')) {
                // 显示时添加动画
                content.classList.add('animate-fade-in');
                setTimeout(() => content.classList.remove('animate-fade-in'), 500);
                // 旋转图标
                icon.style.transform = 'rotate(180deg)';
            } else {
                // 隐藏时恢复图标
                icon.style.transform = 'rotate(0)';
            }
        }

        // 设置语言
        function setLanguage(lang) {
            if (currentLang === lang) return;
            
            currentLang = lang;
            
            // 更新按钮状态
            document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            
            // 更新所有翻译文本（包括状态说明面板）
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.classList.add('opacity-0');
                setTimeout(() => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = getI18n(currentLang, key);
                    el.classList.remove('opacity-0');
                    el.classList.add('animate-fade-in');
                    setTimeout(() => el.classList.remove('animate-fade-in'), 500);
                }, 100);
            });
            
            // 更新工作流卡片
            updateAllWorkflowCards();
            
            // 更新历史记录
            renderHistory();
        }

        // 获取翻译文本
        function getI18n(lang, key, params = []) {
            const keys = key.split('.');
            let value = translations[lang];
            
            for (const k of keys) {
                if (value[k] === undefined) {
                    return key; // 如果找不到翻译，返回原始键
                }
                value = value[k];
            }
            
            // 替换参数
            if (typeof value === 'string' && params.length > 0) {
                return value.replace(/{(\d+)}/g, (match, index) => {
                    return params[index] !== undefined ? params[index] : match;
                });
            }
            
            return value;
        }

        // 创建工作流卡片
        function createWorkflowCards() {
            const container = document.getElementById('workflow-container');
            config.workflows.forEach(workflow => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-6 card-hover animate-fade-in';
                card.id = `card-${workflow.owner}-${workflow.repo}-${workflow.file}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold workflow-name" 
                            data-workflow="${workflow.file}">${workflow.name[currentLang]}</h3>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fa fa-question-circle text-2xl text-gray-400 icon-dynamic" 
                               id="icon-${workflow.owner}-${workflow.repo}-${workflow.file}"></i>
                            <span class="text-gray-600" 
                                  id="status-${workflow.owner}-${workflow.repo}-${workflow.file}">${getI18n(currentLang, 'waiting')}</span>
                        </div>
                        <span class="text-sm text-gray-500" 
                              id="time-${workflow.owner}-${workflow.repo}-${workflow.file}">-</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 text-sm">
                        <a href="#" target="_blank" class="text-primary hover:underline flex items-center" 
                           id="link-${workflow.owner}-${workflow.repo}-${workflow.file}">
                            <i class="fa fa-external-link mr-1"></i> ${getI18n(currentLang, 'viewDetails')}
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 更新所有工作流卡片的语言
        function updateAllWorkflowCards() {
            config.workflows.forEach(workflow => {
                // 更新工作流名称
                const nameElem = document.querySelector(`.workflow-name[data-workflow="${workflow.file}"]`);
                nameElem.classList.add('opacity-0');
                setTimeout(() => {
                    nameElem.textContent = workflow.name[currentLang];
                    nameElem.classList.remove('opacity-0');
                    nameElem.classList.add('animate-fade-in');
                    setTimeout(() => nameElem.classList.remove('animate-fade-in'), 500);
                }, 100);
                
                // 更新查看详情链接文本
                const linkElem = document.getElementById(`link-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                linkElem.classList.add('opacity-0');
                setTimeout(() => {
                    linkElem.innerHTML = `<i class="fa fa-external-link mr-1"></i> ${getI18n(currentLang, 'viewDetails')}`;
                    linkElem.classList.remove('opacity-0');
                    linkElem.classList.add('animate-fade-in');
                    setTimeout(() => linkElem.classList.remove('animate-fade-in'), 500);
                }, 100);
                
                // 如果已有状态数据，更新状态文本和动态图标
                const statusElem = document.getElementById(`status-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                const currentStatus = statusElem.getAttribute('data-status');
                const currentConclusion = statusElem.getAttribute('data-conclusion');
                
                if (currentStatus) {
                    let statusText, iconInfo;
                    if (currentStatus === 'completed' && currentConclusion) {
                        statusText = getI18n(currentLang, `status.completed.${currentConclusion}`);
                        iconInfo = statusIcons.completed[currentConclusion] || statusIcons.completed.default;
                    } else {
                        statusText = getI18n(currentLang, `status.${currentStatus}`);
                        iconInfo = statusIcons[currentStatus] || statusIcons.unknown;
                    }
                    
                    statusElem.classList.add('opacity-0');
                    setTimeout(() => {
                        statusElem.textContent = statusText;
                        statusElem.classList.remove('opacity-0');
                        statusElem.classList.add('animate-fade-in');
                        setTimeout(() => statusElem.classList.remove('animate-fade-in'), 500);
                    }, 100);
                    
                    // 更新动态图标
                    const iconElem = document.getElementById(`icon-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                    updateIconElement(iconElem, iconInfo);
                }
                
                // 更新时间文本
                const timeElem = document.getElementById(`time-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                const timestamp = timeElem.getAttribute('data-timestamp');
                if (timestamp) {
                    timeElem.classList.add('opacity-0');
                    setTimeout(() => {
                        timeElem.textContent = formatRelativeTime(new Date(timestamp));
                        timeElem.classList.remove('opacity-0');
                        timeElem.classList.add('animate-fade-in');
                        setTimeout(() => timeElem.classList.remove('animate-fade-in'), 500);
                    }, 100);
                }
            });
        }

        // 更新图标元素（应用动态效果）
        function updateIconElement(elem, iconInfo) {
            // 清除所有动画类
            elem.classList.remove('animate-bounce-slow', 'animate-pulse-slow', 'animate-spin-slow');
            
            // 添加新的图标和样式
            elem.className = `fa ${iconInfo.icon} text-2xl text-${iconInfo.color} icon-dynamic ${iconInfo.animation}`;
        }

        // 拉取所有仓库的工作流ID
        async function fetchAllWorkflowIds() {
            updateStatusIndicator(getI18n(currentLang, 'initializing'), 'text-pending');
            try {
                const fetchPromises = config.workflows.map(workflow => fetchSingleRepoWorkflowIds(workflow));
                await Promise.all(fetchPromises);

                const missingWfs = config.workflows.filter(workflow => {
                    const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
                    return !workflowIds[key];
                });
                if (missingWfs.length > 0) {
                    const missingText = missingWfs.map(wf => `${wf.name[currentLang]}`).join(', ');
                    console.warn(`未找到以下工作流ID：${missingText}`);
                    updateStatusIndicator(getI18n(currentLang, 'partialInitFailed'), 'text-failure');
                } else {
                    updateStatusIndicator(getI18n(currentLang, 'initCompleted'), 'text-success');
                }

                fetchAllWorkflowStatuses();
            } catch (error) {
                console.error('工作流ID拉取失败：', error);
                updateStatusIndicator(getI18n(currentLang, 'initFailed'), 'text-failure');
            }
        }

        // 拉取单个仓库的工作流列表
        async function fetchSingleRepoWorkflowIds(workflow) {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${workflow.owner}/${workflow.repo}/actions/workflows`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${config.token}`
                        }
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}（${workflow.owner}/${workflow.repo}）`);
                const data = await response.json();

                const targetWf = data.workflows.find(wf => wf.path.endsWith(workflow.file));
                if (targetWf) {
                    const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
                    workflowIds[key] = targetWf.id;
                }
            } catch (error) {
                console.error(`仓库${workflow.owner}/${workflow.repo}工作流ID拉取失败：`, error);
            }
        }

        // 拉取所有工作流状态
        async function fetchAllWorkflowStatuses() {
            // 显示更新动画
            showUpdateAnimation();
            
            updateStatusIndicator(getI18n(currentLang, 'updating'), 'text-pending');
            try {
                const fetchPromises = config.workflows.map(workflow => fetchSingleWorkflowStatus(workflow));
                await Promise.all(fetchPromises);

                const now = new Date();
                const lastUpdateElem = document.getElementById('last-update');
                lastUpdateElem.classList.add('opacity-0');
                setTimeout(() => {
                    lastUpdateElem.textContent = `${getI18n(currentLang, 'lastUpdate').split('：')[0]}：${now.toLocaleString()}`;
                    lastUpdateElem.classList.remove('opacity-0');
                    lastUpdateElem.classList.add('animate-fade-in');
                    setTimeout(() => lastUpdateElem.classList.remove('animate-fade-in'), 500);
                }, 100);
                
                updateStatusIndicator(getI18n(currentLang, 'updateCompleted'), 'text-success');
            } catch (error) {
                console.error('状态更新失败：', error);
                updateStatusIndicator(getI18n(currentLang, 'updateFailed'), 'text-failure');
            } finally {
                // 隐藏更新动画
                hideUpdateAnimation();
            }
        }

        // 显示更新动画
        function showUpdateAnimation() {
            const cards = document.querySelectorAll('#workflow-container > div');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('opacity-70', 'scale-[0.98]');
                }, index * 50);
            });
        }

        // 隐藏更新动画
        function hideUpdateAnimation() {
            const cards = document.querySelectorAll('#workflow-container > div');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.remove('opacity-70', 'scale-[0.98]');
                    card.classList.add('animate-fade-in');
                    setTimeout(() => card.classList.remove('animate-fade-in'), 300);
                }, index * 50);
            });
        }

        // 拉取单个工作流的最新状态
        async function fetchSingleWorkflowStatus(workflow) {
            const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
            const wfId = workflowIds[key];

            if (!wfId) {
                updateWorkflowCard(workflow, { status: 'unknown', conclusion: 'unknown', updated_at: new Date().toISOString() });
                return;
            }

            try {
                // 根据需要显示的历史记录数量，调整API请求的记录数
                const response = await fetch(
                    `https://api.github.com/repos/${workflow.owner}/${workflow.repo}/actions/workflows/${wfId}/runs?per_page=${config.historyRecordsPerWorkflow}`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${config.token}`
                        }
                    }
                );

                // 处理API速率限制
                if (response.status === 403) {
                    const errorData = await response.json();
                    if (errorData.message.includes('API rate limit exceeded')) {
                        console.error(`工作流${workflow.name[currentLang]}：GitHub API速率限制已耗尽`);
                        // 显示速率限制提示
                        updateWorkflowCard(workflow, { 
                            status: 'error', 
                            conclusion: null, 
                            updated_at: new Date().toISOString(),
                            errorMsg: 'API速率限制耗尽'
                        });
                        return;
                    }
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data.workflow_runs && data.workflow_runs.length > 0) {
                    // 更新卡片显示最新一条记录
                    const latestRun = data.workflow_runs[0];
                    updateWorkflowCard(workflow, latestRun);
                    
                    // 将所有获取到的记录添加到历史（API返回的已经是按时间倒序排列的）
                    data.workflow_runs.forEach(run => addToHistory(workflow, run));
                } else {
                    updateWorkflowCard(workflow, { status: 'no_runs', conclusion: null, updated_at: null });
                }
            } catch (error) {
                console.error(`工作流${workflow.name[currentLang]}状态拉取失败：`, error);
                updateWorkflowCard(workflow, { status: 'error', conclusion: null, updated_at: new Date().toISOString() });
            }
        }

        // 更新工作流卡片
        function updateWorkflowCard(workflow, runData) {
            const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
            const iconElem = document.getElementById(`icon-${key}`);
            const statusElem = document.getElementById(`status-${key}`);
            const timeElem = document.getElementById(`time-${key}`);
            const linkElem = document.getElementById(`link-${key}`);
            const cardElem = document.getElementById(`card-${key}`);

            // 保存状态数据用于语言切换时更新
            statusElem.setAttribute('data-status', runData.status);
            statusElem.setAttribute('data-conclusion', runData.conclusion || '');
            
            // 重置样式
            iconElem.className = 'fa text-2xl icon-dynamic';
            statusElem.className = '';
            cardElem.classList.remove('border-l-4', 'border-pending', 'border-success', 'border-failure', 'border-cancelled');

            let statusInfo;
            let timeText = '-';
            let link = `https://github.com/${workflow.owner}/${workflow.repo}/actions/workflows/${workflow.file}`;

            if (runData.status === 'no_runs') {
                statusInfo = statusIcons.no_runs;
                statusElem.textContent = getI18n(currentLang, 'status.no_runs');
            } else if (runData.status === 'error' || runData.status === 'unknown') {
                statusInfo = statusIcons.error;
                // 显示速率限制错误
                if (runData.errorMsg === 'API速率限制耗尽') {
                    statusElem.textContent = getI18n(currentLang, 'status.error') + '（API速率限制）';
                } else {
                    statusElem.textContent = getI18n(currentLang, 'status.error');
                }
            } else {
                // 处理时间 - 使用构建实际完成时间
                if (runData.updated_at) {
                    const buildTime = new Date(runData.updated_at);
                    timeText = formatRelativeTime(buildTime);
                    timeElem.setAttribute('data-timestamp', runData.updated_at);
                }
                
                if (runData.html_url) link = runData.html_url;
                
                // 处理状态
                if (runData.status === 'completed') {
                    const conclusion = runData.conclusion || 'default';
                    statusInfo = statusIcons.completed[conclusion] || statusIcons.completed.default;
                    statusElem.textContent = getI18n(currentLang, `status.completed.${conclusion}`);
                } else {
                    statusInfo = statusIcons[runData.status] || statusIcons.unknown;
                    statusElem.textContent = getI18n(currentLang, `status.${runData.status}`);
                }
                
                cardElem.classList.add('border-l-4', `border-${statusInfo.color}`);
            }

            // 添加状态更新动画
            statusElem.classList.add('opacity-0');
            timeElem.classList.add('opacity-0');
            iconElem.classList.add('opacity-0');
            
            setTimeout(() => {
                // 更新动态图标
                updateIconElement(iconElem, statusInfo);
                
                // 更新其他UI元素
                statusElem.className = `text-${statusInfo.color}`;
                timeElem.textContent = timeText;
                linkElem.href = link;
                
                // 显示淡入动画
                statusElem.classList.remove('opacity-0');
                timeElem.classList.remove('opacity-0');
                iconElem.classList.remove('opacity-0');
                
                statusElem.classList.add('animate-fade-in');
                timeElem.classList.add('animate-fade-in');
                iconElem.classList.add('animate-fade-in');
                
                setTimeout(() => {
                    statusElem.classList.remove('animate-fade-in');
                    timeElem.classList.remove('animate-fade-in');
                    iconElem.classList.remove('animate-fade-in');
                }, 500);
            }, 200);
        }

        // 添加到历史记录（按工作流分组，每组最多N条，确保最新的在最上方）
        function addToHistory(workflow, runData) {
            // 1. 过滤无效记录（无状态、无ID、无时间的记录不保存）
            if (!runData.status || !runData.id || !runData.updated_at) {
                return;
            }

            // 2. 获取当前工作流的状态图标、颜色等信息
            let statusInfo;
            if (runData.status === 'completed') {
                const conclusion = runData.conclusion || 'default';
                statusInfo = {
                    icon: statusIcons.completed[conclusion]?.icon || statusIcons.unknown.icon,
                    color: statusIcons.completed[conclusion]?.color || statusIcons.unknown.color,
                    animation: statusIcons.completed[conclusion]?.animation || '',
                    key: `status.completed.${conclusion}`
                };
            } else {
                statusInfo = {
                    icon: statusIcons[runData.status]?.icon || statusIcons.unknown.icon,
                    color: statusIcons[runData.status]?.color || statusIcons.unknown.color,
                    animation: statusIcons[runData.status]?.animation || '',
                    key: `status.${runData.status}`
                };
            }

            // 3. 构造历史记录项
            const buildTime = new Date(runData.updated_at);
            const historyItem = {
                id: runData.id, // 构建记录唯一ID（用于去重）
                timestamp: buildTime,
                statusKey: statusInfo.key,
                color: statusInfo.color,
                icon: statusInfo.icon,
                animation: statusInfo.animation,
                url: runData.html_url // 构建详情链接
            };

            // 4. 按工作流ID分组存储（确保每组最多N条）
            const workflowKey = workflow.id; // 用工作流唯一ID作为分组键
            // 初始化该工作流的记录数组（若未存在）
            if (!groupedHistory[workflowKey]) {
                groupedHistory[workflowKey] = [];
            }

            // 5. 去重（避免重复添加同一条构建记录）
            const isDuplicate = groupedHistory[workflowKey].some(item => item.id === runData.id);
            if (isDuplicate) {
                return;
            }

            // 6. 添加新记录并按时间倒序排序（最新的在前）
            groupedHistory[workflowKey].push(historyItem);
            
            // 强制按时间戳倒序排序，确保最新的记录在最上方
            groupedHistory[workflowKey].sort((a, b) => b.timestamp - a.timestamp);
            
            // 仅保留最近config.historyRecordsPerWorkflow条（删除超出部分）
            if (groupedHistory[workflowKey].length > config.historyRecordsPerWorkflow) {
                groupedHistory[workflowKey].splice(config.historyRecordsPerWorkflow);
            }

            // 7. 重新渲染历史记录
            renderHistory();
        }

        // 渲染历史记录（按工作流分组，每组最多N条，最新的在最上方）
        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = ''; // 清空原有内容

            // 1. 遍历所有配置的工作流，按组渲染
            config.workflows.forEach((workflow, workflowIndex) => {
                const workflowKey = workflow.id;
                // 确保记录数组已按时间倒序排序
                const workflowRecords = groupedHistory[workflowKey] ? [...groupedHistory[workflowKey]] : [];
                
                // 2. 创建工作流分组容器
                const groupContainer = document.createElement('div');
                groupContainer.className = 'mb-6 last:mb-0 opacity-0'; // 初始透明，用于动画
                // 添加分组标题（工作流名称）
                groupContainer.innerHTML = `
                    <h3 class="text-base font-semibold mb-2 text-primary flex items-center">
                        <i class="fa fa-caret-right mr-2"></i>
                        ${workflow.name[currentLang]}
                    </h3>
                    <div class="pl-4 space-y-2" id="records-${workflowKey}">
                        <!-- 该工作流的记录将动态插入这里 -->
                    </div>
                `;
                container.appendChild(groupContainer);

                // 3. 获取当前工作流的记录容器，插入记录或提示
                const recordsContainer = groupContainer.querySelector(`#records-${workflowKey}`);
                if (workflowRecords.length === 0) {
                    // 无记录时显示提示
                    recordsContainer.innerHTML = `
                        <p class="text-gray-500 text-sm italic">${getI18n(currentLang, 'noHistoryForWorkflow')}</p>
                    `;
                } else {
                    // 有记录时，遍历渲染每条记录（已经是按时间倒序）
                    workflowRecords.forEach((record, recordIndex) => {
                        const statusText = getI18n(currentLang, record.statusKey);
                        const entry = document.createElement('div');
                        entry.className = 'flex items-center justify-between py-1.5 border-b border-gray-100 last:border-0 history-item opacity-0';
                        entry.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <i class="fa ${record.icon} text-${record.color} ${record.animation} text-sm"></i>
                                <span class="text-${record.color} text-sm">${statusText}</span>
                            </div>
                            <a href="${record.url || '#'}" target="_blank" class="text-gray-500 text-xs hover:text-primary flex items-center">
                                ${record.timestamp.toLocaleString()}
                                <i class="fa fa-external-link ml-1 text-[8px]"></i>
                            </a>
                        `;
                        recordsContainer.appendChild(entry);

                        // 记录项的淡入动画（最新的先显示）
                        setTimeout(() => {
                            entry.classList.remove('opacity-0');
                            entry.classList.add('animate-slide-up');
                            setTimeout(() => entry.classList.remove('animate-slide-up'), 300);
                        }, workflowIndex * 100 + recordIndex * 50);
                    });
                }

                // 工作流分组的淡入动画
                setTimeout(() => {
                    groupContainer.classList.remove('opacity-0');
                    groupContainer.classList.add('animate-fade-in');
                    setTimeout(() => groupContainer.classList.remove('animate-fade-in'), 300);
                }, workflowIndex * 100);
            });
        }

        // 更新状态指示器
        function updateStatusIndicator(text, className) {
            const indicator = document.getElementById('status-indicator');
            indicator.classList.add('opacity-0');
            
            setTimeout(() => {
                indicator.className = '';
                indicator.classList.add(...className.split(' '));
                indicator.textContent = text;
                indicator.classList.remove('opacity-0');
                indicator.classList.add('animate-fade-in');
                
                setTimeout(() => {
                    indicator.classList.remove('animate-fade-in');
                }, 500);
            }, 100);
        }

        // 格式化相对时间（支持多语言）
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return getI18n(currentLang, 'time.justNow');
            if (diffMins < 60) return getI18n(currentLang, 'time.minutesAgo', [diffMins]);
            if (diffHours < 24) return getI18n(currentLang, 'time.hoursAgo', [diffHours]);
            return getI18n(currentLang, 'time.daysAgo', [diffDays]);
        }
    </script>
</body>
</html>